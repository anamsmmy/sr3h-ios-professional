name: 🎯 Build iOS IPA - محوّل سرعة SR3H

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'نوع البناء'
        required: true
        default: 'development'   
        type: choice
        options:
        - development
        - ad-hoc
        - app-store

jobs:
  build-ios:
    name: 🎯 Build iOS App
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 🔧 Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'

    - name: 🔧 Setup Flutter
      run: |
        git clone https://github.com/flutter/flutter.git -b stable --depth 1
        echo "$PWD/flutter/bin" >> $GITHUB_PATH
        export PATH="$PWD/flutter/bin:$PATH"
        flutter --version
        flutter doctor

    - name: 📦 Install Dependencies
      run: |
        flutter pub get
        flutter pub deps

    - name: 🧹 Clean iOS Build
      run: |
        flutter clean
        cd ios
        rm -rf Pods
        rm -rf .symlinks
        rm -rf Flutter/Flutter.framework
        rm -rf Flutter/Flutter.podspec
        rm -rf build/

    - name: 🔧 Setup iOS Pods
      run: |
        cd ios
        pod install --repo-update

    - name: 🏗️ Build iOS Archive
      run: |
        flutter build ios --release --no-codesign
        
        echo "📱 Building iOS Archive..."
        cd ios
        xcodebuild -workspace Runner.xcworkspace \
                   -scheme Runner \
                   -configuration Release \
                   -destination generic/platform=iOS \
                   -archivePath ../build/ios/Runner.xcarchive \
                   archive \
                   CODE_SIGNING_ALLOWED=NO \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGN_IDENTITY="" \
                   PROVISIONING_PROFILE=""

    - name: 🎯 Create Unsigned IPA
      run: |
        echo "📱 Creating unsigned IPA for sideloading..."
        
        # Check if archive exists
        if [ ! -d "build/ios/Runner.xcarchive" ]; then
          echo "❌ Archive not found!"
          ls -la build/ios/
          exit 1
        fi
        
        echo "✅ Archive found, proceeding..."
        
        # Create IPA directory
        mkdir -p build/ios/ipa
        
        # Extract app from archive
        echo "📦 Extracting app from archive..."
        if [ ! -d "build/ios/Runner.xcarchive/Products/Applications/Runner.app" ]; then
          echo "❌ Runner.app not found in archive!"
          ls -la build/ios/Runner.xcarchive/Products/Applications/
          exit 1
        fi
        
        cp -r build/ios/Runner.xcarchive/Products/Applications/Runner.app build/ios/ipa/
        
        # Create IPA structure
        cd build/ios/ipa
        mkdir -p Payload
        mv Runner.app Payload/
        
        # Create unsigned IPA
        echo "🔧 Creating IPA file..."
        zip -r "SR3H_Video_Converter_v2.0.6_unsigned.ipa" Payload/
        
        echo "✅ Unsigned IPA created successfully!"
        ls -la *.ipa
        echo "📊 File size: $(du -h *.ipa | cut -f1)"

    - name: 📦 Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 📱 SR3H Video Converter IPA
        path: build/ios/ipa/*.ipa
        retention-days: 30

    - name: 📋 Build Summary
      run: |
        echo "## 🎉 iOS Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "📱 **App Name:** محوّل سرعة SR3H" >> $GITHUB_STEP_SUMMARY
        echo "🔢 **Version:** 2.0.6 (206)" >> $GITHUB_STEP_SUMMARY
        echo "🏗️ **Build Type:** ${{ github.event.inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
        echo "📱 **iOS Target:** 12.0+" >> $GITHUB_STEP_SUMMARY
        echo "📱 **Devices:** iPhone, iPad" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "=> **Status:** Build Successful ✅" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 📱 Installation Instructions:" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the IPA from Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "2. Use **AltStore**, **Sideloadly**, or **3uTools**" >> $GITHUB_STEP_SUMMARY
        echo "3. Install with your **Apple ID** (free account)" >> $GITHUB_STEP_SUMMARY
        echo "4. Trust the developer in **Settings > General > VPN & Device Management**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "⚠️ **Note:** Free Apple ID signing lasts 7 days, then re-sign needed" >> $GITHUB_STEP_SUMMARY