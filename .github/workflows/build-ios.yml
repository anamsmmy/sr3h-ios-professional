name: ðŸŽ¯ Build iOS IPA - Ù…Ø­ÙˆÙ‘Ù„ Ø³Ø±Ø¹Ø© SR3H

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡'
        required: true
        default: 'development'   
        type: choice
        options:
        - development
        - ad-hoc
        - app-store

jobs:
  build-ios:
    name: ðŸŽ¯ Build iOS App
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ”§ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'

    - name: ðŸ”§ Setup Flutter
      run: |
        git clone https://github.com/flutter/flutter.git -b stable --depth 1
        echo "$PWD/flutter/bin" >> $GITHUB_PATH
        export PATH="$PWD/flutter/bin:$PATH"
        flutter --version
        flutter doctor

    - name: ðŸ“¦ Install Dependencies
      run: |
        flutter pub get
        flutter pub deps

    - name: ðŸ§¹ Clean iOS Build
      run: |
        flutter clean
        cd ios
        rm -rf Pods
        rm -rf .symlinks
        rm -rf Flutter/Flutter.framework
        rm -rf Flutter/Flutter.podspec
        rm -rf build/

    - name: ðŸ”§ Setup iOS Pods
      run: |
        cd ios
        pod install --repo-update

    - name: ðŸ—ï¸ Build iOS Archive
      run: |
        flutter build ios --release --no-codesign
        
        echo "ðŸ“± Building iOS Archive..."
        cd ios
        xcodebuild -workspace Runner.xcworkspace \
                   -scheme Runner \
                   -configuration Release \
                   -destination generic/platform=iOS \
                   -archivePath ../build/ios/Runner.xcarchive \
                   archive \
                   CODE_SIGNING_ALLOWED=NO \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGN_IDENTITY="" \
                   PROVISIONING_PROFILE=""

    - name: ðŸŽ¯ Create Unsigned IPA
      run: |
        echo "ðŸ“± Creating unsigned IPA for sideloading..."
        
        # Check if archive exists
        if [ ! -d "build/ios/Runner.xcarchive" ]; then
          echo "âŒ Archive not found!"
          ls -la build/ios/
          exit 1
        fi
        
        echo "âœ… Archive found, proceeding..."
        
        # Create IPA directory
        mkdir -p build/ios/ipa
        
        # Extract app from archive
        echo "ðŸ“¦ Extracting app from archive..."
        if [ ! -d "build/ios/Runner.xcarchive/Products/Applications/Runner.app" ]; then
          echo "âŒ Runner.app not found in archive!"
          ls -la build/ios/Runner.xcarchive/Products/Applications/
          exit 1
        fi
        
        cp -r build/ios/Runner.xcarchive/Products/Applications/Runner.app build/ios/ipa/
        
        # Create IPA structure
        cd build/ios/ipa
        mkdir -p Payload
        mv Runner.app Payload/
        
        # Create unsigned IPA
        echo "ðŸ”§ Creating IPA file..."
        zip -r "SR3H_Video_Converter_v2.0.6_unsigned.ipa" Payload/
        
        echo "âœ… Unsigned IPA created successfully!"
        ls -la *.ipa
        echo "ðŸ“Š File size: $(du -h *.ipa | cut -f1)"

    - name: ðŸ“¦ Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ðŸ“± SR3H Video Converter IPA
        path: build/ios/ipa/*.ipa
        retention-days: 30

    - name: ðŸ“‹ Build Summary
      run: |
        echo "## ðŸŽ‰ iOS Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“± **App Name:** Ù…Ø­ÙˆÙ‘Ù„ Ø³Ø±Ø¹Ø© SR3H" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”¢ **Version:** 2.0.6 (206)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ—ï¸ **Build Type:** ${{ github.event.inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“± **iOS Target:** 12.0+" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“± **Devices:** iPhone, iPad" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "=> **Status:** Build Successful âœ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“± Installation Instructions:" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the IPA from Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "2. Use **AltStore**, **Sideloadly**, or **3uTools**" >> $GITHUB_STEP_SUMMARY
        echo "3. Install with your **Apple ID** (free account)" >> $GITHUB_STEP_SUMMARY
        echo "4. Trust the developer in **Settings > General > VPN & Device Management**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âš ï¸ **Note:** Free Apple ID signing lasts 7 days, then re-sign needed" >> $GITHUB_STEP_SUMMARY