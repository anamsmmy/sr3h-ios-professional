name: Build iOS IPA

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - ad-hoc

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Clean build
      run: flutter clean
    
    - name: Build Flutter iOS (Release)
      run: flutter build ios --release --no-codesign
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Create ExportOptions.plist
      run: |
        cat > ExportOptions.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>${{ github.event.inputs.build_type }}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <false/>
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
        </dict>
        </plist>
        EOF
    
    - name: Build Archive
      run: |
        xcodebuild -workspace ios/Runner.xcworkspace \
                   -scheme Runner \
                   -configuration Release \
                   -destination generic/platform=iOS \
                   -archivePath build/ios/Runner.xcarchive \
                   archive
    
    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
                   -archivePath build/ios/Runner.xcarchive \
                   -exportPath build/ios/ipa \
                   -exportOptionsPlist ExportOptions.plist
    
    - name: Rename IPA
      run: |
        cd build/ios/ipa
        for file in *.ipa; do
          if [ -f "$file" ]; then
            mv "$file" "SR3H-VideoConverter-v2.0.6-${{ github.event.inputs.build_type }}-$(date +%Y%m%d-%H%M%S).ipa"
          fi
        done
    
    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SR3H-VideoConverter-IPA-${{ github.event.inputs.build_type }}
        path: build/ios/ipa/*.ipa
        retention-days: 30
    
    - name: Create iOS Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ios-v2.0.6-${{ github.event.inputs.build_type }}-${{ github.run_number }}
        name: Ù…Ø­ÙˆÙ‘Ù„ Ø³Ø±Ø¹Ø© iOS v2.0.6 (${{ github.event.inputs.build_type }})
        body: |
          ## ðŸ“± Ù…Ø­ÙˆÙ‘Ù„ Ø³Ø±Ø¹Ø© - Ù†Ø³Ø®Ø© iOS
          
          ### ðŸŽ¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡:
          - **Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** 2.0.6
          - **Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡:** ${{ github.event.inputs.build_type }}
          - **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù†Ø§Ø¡:** $(date)
          - **Ø§Ù„Ù…Ù†ØµØ©:** iOS 12.0+
          
          ### âœ¨ Ø§Ù„Ù…ÙŠØ²Ø§Øª:
          - âœ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ 60 Ø¥Ø·Ø§Ø± ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ©
          - âœ… Ù†Ø¸Ø§Ù… ØªÙØ¹ÙŠÙ„ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
          - âœ… ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ù…Ù„Ø© ÙˆÙ…ØªØ¬Ø§ÙˆØ¨Ø©
          - âœ… Ø¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ ØµÙŠØº Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
          - âœ… Ø­ÙØ¸ Ù…Ù†Ø¸Ù… ÙÙŠ Ù…Ø¬Ù„Ø¯ SR3H
          - âœ… ÙØ­Øµ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
          
          ### ðŸ“± Ø§Ù„ØªØ«Ø¨ÙŠØª:
          1. **Ø­Ù…Ù‘Ù„ Ù…Ù„Ù IPA** Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„
          2. **Ø«Ø¨Ù‘Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…:**
             - AltStore (Ø§Ù„Ø£ÙØ¶Ù„)
             - Sideloadly
             - 3uTools
             - Xcode (Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ†)
          3. **ÙˆØ«Ù‘Ù‚ Ø§Ù„Ù…Ø·ÙˆØ±** ÙÙŠ: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª > Ø¹Ø§Ù… > Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
          4. **Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚** ÙˆØ§Ø³ØªÙ…ØªØ¹!
          
          ### ðŸ” Ø§Ù„ØªÙØ¹ÙŠÙ„:
          - **Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ:** test@example.com
          - **Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ**
          
          ### ðŸ“‹ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:
          - iOS 12.0 Ø£Ùˆ Ø£Ø­Ø¯Ø«
          - iPhone Ø£Ùˆ iPad
          - Ù…Ø³Ø§Ø­Ø© ØªØ®Ø²ÙŠÙ† ~50 MB
          - Ø§ØªØµØ§Ù„ Ø¥Ù†ØªØ±Ù†Øª Ù„Ù„ØªÙØ¹ÙŠÙ„
          
          ### ðŸ› ï¸ Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡:
          - **Development:** Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø®ØµÙŠ (ØµØ§Ù„Ø­ 7 Ø£ÙŠØ§Ù…)
          - **Ad-Hoc:** Ù„Ø£Ø¬Ù‡Ø²Ø© Ù…Ø­Ø¯Ø¯Ø© (ØµØ§Ù„Ø­ Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©)
          
          ### ðŸ“ž Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ:
          - **Ø§Ù„Ø¨Ø±ÙŠØ¯:** ios-support@sr3h.com
          - **Ù…ØªÙˆÙØ±ÙˆÙ† 24/7** Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ
          
          ---
          
          ### ðŸŽ‰ Ù…Ù„Ù IPA ØµØ­ÙŠØ­ ÙˆÙ…Ù‡Ù†ÙŠ!
          **Ù…Ø¨Ù†ÙŠ Ø¨Ù€ xcodebuild Ø¹Ù„Ù‰ macOS Ø­Ù‚ÙŠÙ‚ÙŠ - Ø¨Ø¯ÙˆÙ† Ù…Ù„ÙØ§Øª .dart Ù…ØµØ¯Ø±ÙŠØ©**
        files: build/ios/ipa/*.ipa
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build Summary
      run: |
        echo "## ðŸŽ‰ ØªÙ… Ø¨Ù†Ø§Ø¡ IPA Ø¨Ù†Ø¬Ø§Ø­!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡" >> $GITHUB_STEP_SUMMARY
        echo "- **Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:** Ù…Ø­ÙˆÙ‘Ù„ Ø³Ø±Ø¹Ø© SR3H" >> $GITHUB_STEP_SUMMARY
        echo "- **Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** 2.0.6" >> $GITHUB_STEP_SUMMARY
        echo "- **Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡:** ${{ github.event.inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Ø§Ù„Ù…Ù†ØµØ©:** iOS" >> $GITHUB_STEP_SUMMARY
        echo "- **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù†Ø§Ø¡:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Ø§Ù„ØªØ­Ù…ÙŠÙ„" >> $GITHUB_STEP_SUMMARY
        echo "Ù…Ù„Ù IPA Ù…ØªÙˆÙØ± ÙÙŠ Ù‚Ø³Ù… **Artifacts** Ø£Ø¹Ù„Ø§Ù‡." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Ø§Ù„ØªØ«Ø¨ÙŠØª" >> $GITHUB_STEP_SUMMARY
        echo "1. Ø­Ù…Ù‘Ù„ Ù…Ù„Ù IPA Ù…Ù† Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "2. Ø«Ø¨Ù‘Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… AltStore Ø£Ùˆ Sideloadly Ø£Ùˆ Xcode" >> $GITHUB_STEP_SUMMARY
        echo "3. ÙˆØ«Ù‘Ù‚ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ø·ÙˆØ± ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª iOS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!" >> $GITHUB_STEP_SUMMARY
        echo "Ù…Ù„Ù IPA Ø§Ù„Ù…Ù‡Ù†ÙŠ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª!" >> $GITHUB_STEP_SUMMARY