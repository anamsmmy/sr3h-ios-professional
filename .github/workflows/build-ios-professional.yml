name: ğŸ Build Professional iOS IPA - Ù…Ø­ÙˆÙ‘Ù„ Ø³Ø±Ø¹Ø© SR3H v2.0.8

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - ad-hoc
        - app-store

jobs:
  build-ios:
    name: ğŸ Build Professional iOS IPA
    runs-on: macos-latest
    timeout-minutes: 90
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 'stable'
        channel: 'stable'
        
    - name: ğŸ“¦ Install Dependencies
      run: flutter pub get
      
    - name: ğŸ§¹ Clean Build
      run: |
        flutter clean
        cd ios
        rm -rf Pods
        rm -rf .symlinks
        rm -rf Flutter/Flutter.framework
        rm -rf Flutter/Flutter.podspec
        
    - name: ğŸ Pod Install
      run: |
        cd ios
        pod install --repo-update
        
    - name: âš™ï¸ Create Export Options
      run: |
        cat > ios/ExportOptions.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>automatic</string>
        </dict>
        </plist>
        EOF
        
    - name: ğŸ”¨ Build Flutter iOS
      run: |
        flutter build ios --release --no-codesign --verbose
        
    - name: ğŸ“¦ Create Xcode Archive
      run: |
        cd ios
        xcodebuild archive \
          -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath ../build/ios/Runner.xcarchive \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO
        
    - name: ğŸ“± Export Professional IPA
      run: |
        cd ios
        xcodebuild -exportArchive \
          -archivePath ../build/ios/Runner.xcarchive \
          -exportPath ../build/ios/ipa \
          -exportOptionsPlist ExportOptions.plist
        
    - name: ğŸ” Debug Build Paths
      if: failure()
      run: |
        echo "=== Debugging Build Paths ==="
        find build -name "*.app" -type d || echo "No .app found"
        ls -la build/ios/ || echo "No build/ios directory"
        
    - name: ğŸ”§ Create Manual IPA (Fallback)
      if: failure()
      run: |
        # Find the .app file
        APP_PATH=$(find build -name "Runner.app" -type d | head -1)
        if [ -z "$APP_PATH" ]; then
          echo "âŒ Runner.app not found"
          exit 1
        fi
        
        echo "âœ… Found Runner.app at: $APP_PATH"
        
        # Create IPA manually
        mkdir -p manual_ipa/Payload
        cp -r "$APP_PATH" manual_ipa/Payload/
        cd manual_ipa
        zip -r ../sr3h-professional.ipa Payload/
        cd ..
        
        echo "âœ… Manual IPA created successfully"
        
    - name: ğŸ“¦ Create Additional IPA (Always)
      if: always()
      run: |
        # Always try to create an IPA from Flutter build
        if [ -d "build/ios/Release-iphoneos/Runner.app" ]; then
          echo "âœ… Creating IPA from Flutter build..."
          mkdir -p flutter_ipa/Payload
          cp -r build/ios/Release-iphoneos/Runner.app flutter_ipa/Payload/
          cd flutter_ipa
          zip -r ../SR3H_Video_Converter_v2.0.8_unsigned.ipa Payload/
          cd ..
          echo "âœ… Flutter IPA created: SR3H_Video_Converter_v2.0.8_unsigned.ipa"
        else
          echo "âš ï¸ Flutter build not found, skipping additional IPA"
        fi
        
    - name: â¬†ï¸ Upload Professional IPA
      uses: actions/upload-artifact@v4
      with:
        name: SR3H-Professional-IPA-v2.0.8
        path: |
          build/ios/ipa/*.ipa
          sr3h-professional.ipa
          SR3H_Video_Converter_v2.0.8_unsigned.ipa
          *.ipa
        retention-days: 30
        
    - name: ğŸ“‹ Build Summary
      if: always()
      run: |
        echo "## ğŸ‰ Professional iOS Build Complete!"
        echo "ğŸ“± **App:** Ù…Ø­ÙˆÙ‘Ù„ Ø³Ø±Ø¹Ø© SR3H"
        echo "ğŸ“± **Version:** 2.0.8"
        echo "ğŸ **Type:** Professional IPA"
        echo "ğŸ“± **iOS:** 12.0+"
        echo "âœ… **Status:** Build Completed Successfully"
